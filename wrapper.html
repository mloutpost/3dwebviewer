<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LC Timberframes â€¢ 3D Model Viewer</title>
  <link rel="icon" type="image/png" href="assets/global_graphics/LCTF Profile.png">
  <style>
    :root {
      --bg: #0b1020;
      --text: rgba(255, 255, 255, 0.92);
      --border: rgba(255, 255, 255, 0.14);
    }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      overflow: hidden;
    }
    #viewer-frame {
      border: none;
      width: 100%;
      height: 100%;
      background: #fff; /* Models often expect white bg or handle their own */
    }
  </style>
  <script src="https://app.metricslite.com/tracker-1.0.js" data-site-id="7a184184-bbf4-4ec1-81ba-8d738decb242"></script>
  </head>
<body>
  <iframe id="viewer-frame" title="Model Viewer" allowfullscreen sandbox="allow-same-origin allow-scripts allow-popups allow-forms" referrerpolicy="no-referrer"></iframe>

  <script>
    // Suppress non-critical Cadwork viewer configuration errors
    // Override console.error to filter out known non-critical errors
    const originalConsoleError = console.error;
    console.error = function(...args) {
      const errorMessage = args.join(' ');
      // Filter out "Application configuration not downloaded" errors from Cadwork viewers
      // These are often non-critical - the viewer may still function without remote config
      if (errorMessage.includes('Application configuration not downloaded')) {
        // Suppress the error - don't log it
        return;
      }
      // Log all other errors normally
      originalConsoleError.apply(console, args);
    };

    // Also catch window errors
    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('Application configuration not downloaded')) {
        e.preventDefault();
        return true; // Suppress the error
      }
    }, true);

    // Catch unhandled promise rejections
    window.addEventListener('unhandledrejection', function(e) {
      const reason = e.reason?.message || String(e.reason || '');
      if (reason.includes('Application configuration not downloaded')) {
        e.preventDefault();
      }
    });

    // Get 'model' param from URL
    const urlParams = new URLSearchParams(window.location.search);
    const modelPath = urlParams.get('model');
    
    if (!modelPath) {
      alert("No model specified.");
      window.location.href = "index.html";
    }

    const iframe = document.getElementById('viewer-frame');
    
    // Try to override console.error in iframe BEFORE it loads
    // Use a polling approach to catch it as early as possible
    const tryOverrideIframeConsole = () => {
      try {
        const iframeWindow = iframe.contentWindow;
        const iframeDoc = iframe.contentDocument;
        
        if (iframeWindow && iframeWindow.console && iframeDoc) {
          // Override console.error in iframe
          const iframeOriginalError = iframeWindow.console.error;
          iframeWindow.console.error = function(...args) {
            const errorMessage = args.join(' ');
            // Suppress "Application configuration not downloaded" errors
            if (errorMessage.includes('Application configuration not downloaded')) {
              return; // Don't log the error
            }
            // Log all other errors normally
            iframeOriginalError.apply(iframeWindow.console, args);
          };

          // Inject script at the very beginning of iframe head to catch errors early
          const script = iframeDoc.createElement('script');
          script.textContent = `
            (function() {
              const originalError = console.error;
              console.error = function(...args) {
                const msg = args.join(' ');
                if (msg && msg.includes('Application configuration not downloaded')) {
                  return; // Suppress
                }
                originalError.apply(console, args);
              };
            })();
          `;
          if (iframeDoc.head) {
            iframeDoc.head.insertBefore(script, iframeDoc.head.firstChild);
          } else if (iframeDoc.documentElement) {
            iframeDoc.documentElement.insertBefore(script, iframeDoc.documentElement.firstChild);
          }
          
          return true; // Successfully overrode
        }
      } catch (e) {
        // Cross-origin or not ready yet
      }
      return false;
    };

    // Try immediately, then on load, and also poll briefly
    if (!tryOverrideIframeConsole()) {
      const pollInterval = setInterval(() => {
        if (tryOverrideIframeConsole()) {
          clearInterval(pollInterval);
        }
      }, 50);
      
      // Stop polling after 2 seconds
      setTimeout(() => clearInterval(pollInterval), 2000);
    }
    
    // Prevent iframe from navigating parent window
    iframe.addEventListener('load', function() {
      tryOverrideIframeConsole(); // Try again on load
      
      try {
        // Intercept any link clicks within the iframe
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (iframeDoc) {
          const links = iframeDoc.querySelectorAll('a[href]');
          links.forEach(link => {
            link.addEventListener('click', function(e) {
              const href = this.getAttribute('href');
              if (href && (href.includes('wrapper.html') || href.includes('detail.html') || href.includes('index.html'))) {
                e.preventDefault();
                e.stopPropagation();
                return false;
              }
            }, true);
          });
        }
      } catch (e) {
        // Cross-origin restrictions
      }
    });
    
    iframe.src = modelPath;
  </script>
</body>
</html>
